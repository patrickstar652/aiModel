<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èŠå¤©æ©Ÿå™¨äºº (Groq API)</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <h2>
        <span>é–‹</span>
        <span>å§‹</span>
        <span>èŠ</span>
        <span>å¤©</span>
        <span>ï¼</span>
    </h2>

    <div id="chat-box"></div>
    <br>
    <br>
    <form id="chat-form">
        <textarea name="user_input" id="user_input" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..."></textarea><br><br>
        <button type="submit">ç™¼é€</button>
    </form>

    <script>
        let chatHistory = []; // ğŸ”¥ å­˜æ”¾å°è©±ç´€éŒ„ï¼ˆåªåœ¨ç•¶å‰é é¢æœ‰æ•ˆï¼‰

        document.getElementById("chat-form").addEventListener("submit", function(event) {
            event.preventDefault();

            let userInput = document.getElementById("user_input").value.trim();
            if (!userInput) {
                alert("è«‹è¼¸å…¥å…§å®¹ï¼");
                return;
            }

            // ğŸ”¥ å…ˆé¡¯ç¤ºä½¿ç”¨è€…è¼¸å…¥ï¼ˆé¿å… `fetch` å…§é‡è¤‡ pushï¼‰
            chatHistory.push({ role: "user", content: userInput });
            updateChatBox();
            document.getElementById("user_input").value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†

            let formData = new FormData();
            formData.append("user_input", userInput);
            formData.append("chat_history", JSON.stringify(chatHistory)); // ğŸ”¥ å‚³é€å°è©±ç´€éŒ„

            fetch("process.php", { method: "POST", body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("chat-box").innerHTML += `<p style='color: red;'>éŒ¯èª¤ï¼š${data.error}</p>`;
                    return;
                }

                // ğŸ”¥ é¿å…é‡è¤‡ pushï¼Œåƒ…åŠ å…¥æ–°çš„ AI å›æ‡‰
                let newMessages = data.chat_history.slice(chatHistory.length);
                newMessages.forEach(message => {
                    if (message.role === "assistant") {
                        chatHistory.push(message);
                    }
                });

                updateChatBox();
            })
            .catch(error => {
                document.getElementById("chat-box").innerHTML += "<p style='color: red;'>ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼</p>";
                console.error("éŒ¯èª¤:", error);
            });
        });

        // ğŸ”¥ æ›´æ–°èŠå¤©è¦–çª—ï¼ˆåŠ ä¸ŠèŠå¤©æ°£æ³¡ï¼‰
        function updateChatBox() {
            let chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = ""; // å…ˆæ¸…ç©º
            chatHistory.forEach(message => {
                let messageDiv = document.createElement("div");
                messageDiv.classList.add("message-container");

                let contentDiv = document.createElement("div");
                contentDiv.textContent = message.content;
                
                if (message.role === "user") {
                    contentDiv.classList.add("user-message");
                } else if (message.role === "assistant") {
                    contentDiv.classList.add("ai-message");
                }

                messageDiv.appendChild(contentDiv);
                chatBox.appendChild(messageDiv);
            });

            // ğŸ”¥ è®“è¦–çª—è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°å°è©±
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>
